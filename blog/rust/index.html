<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Rust无畏并发</title><meta content=Rust无畏并发 name=title><meta content=NOVA-ME name=author><meta content="The road is life." name=description><meta content=website property=og:type><meta content=https://nova-me.github.io/blog/rust/ property=og:url><meta content=NOVA-ME property=og:site_name><meta content=Rust无畏并发 property=og:title><meta content="The road is life." property=og:description><meta content=https://nova-me.github.io/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nova-me.github.io/blog/rust/ property=twitter:url><meta content=Rust无畏并发 property=twitter:title><meta content="The road is life." property=twitter:description><meta content=https://nova-me.github.io/favicon.ico property=twitter:image><link href=https://nova-me.github.io/blog/rust/ rel=canonical><link rel="shortcut icon" href=https://nova-me.github.io/favicon.ico type=image/x-icon><link href="https://nova-me.github.io/ atom.xml" rel=alternate title=RSS type=application/atom+xml><link href=https://nova-me.github.io/css/style.css rel=stylesheet><body><div class=wrapper><header><nav class=navBar><a href=/>/home/</a><a href=/about>/about/</a><a href=/blog>/blog/</a><a href=/tags>/tags/</a><div class=themeSwitch><button class="themeButton light" onclick="setTheme('light')" title="Light mode">◐</button><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode">◑</button></div><script>const setTheme=a=>{document.documentElement.className=a;localStorage.setItem('theme',a)};const getTheme=()=>{const a=localStorage.getItem('theme');a&&setTheme(a)};getTheme()</script></nav><div><a href=..>..</a>/<span class=metaData>rust</span></div><time datetime=2021-07-25>Published on: <span class=metaData>2021-07-25</span></time><h1>Rust无畏并发</h1></header><main><p>并发常见问题如下：<ul><li>竞争状态（Race conditions），多个线程以不一致的顺序访问数据或资源<li>死锁（Deadlocks），两个线程互相等待对方停止使用其所拥有的资源，这会阻止它们继续运行<li>只会发生在特定情况且难以稳定重现和修复的 bug</ul><p>接下来看看 Rust 中是如何处理并发问题的</p><span id=continue-reading></span><h2 id=biao-zhun-ku-zhong-de-bing-fa>标准库中的并发</h2><p>标准库的<code>thread::spawn</code>会创建一个线程去执行传入的闭包函数，如下所示，join放在注释处的话，主线程会等待直到新线程执行完毕才开始执行<pre class=language-rust data-lang=rust style=background:#2e3440;color:#d8dee9><code class=language-rust data-lang=rust><span style=color:#81a1c1>use </span><span>std</span><span style=color:#81a1c1>::</span><span>{thread</span><span style=color:#eceff4>, </span><span>time</span><span style=color:#81a1c1>::</span><span>Duration}</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>fn </span><span style=color:#88c0d0>main</span><span>() {
</span><span>    </span><span style=color:#81a1c1>let</span><span> handler </span><span style=color:#81a1c1>= </span><span>thread</span><span style=color:#81a1c1>::</span><span>spawn(|| {
</span><span>        </span><span style=color:#81a1c1>for</span><span> i </span><span style=color:#81a1c1>in </span><span style=color:#b48ead>1</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>10 </span><span>{
</span><span>            println!(</span><span style=color:#a3be8c>"hi number </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>, from the spawn thread!"</span><span style=color:#eceff4>,</span><span> i)</span><span style=color:#eceff4>;
</span><span>            thread</span><span style=color:#81a1c1>::</span><span>sleep(Duration</span><span style=color:#81a1c1>::</span><span>from_secs(</span><span style=color:#b48ead>1</span><span>))</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    })</span><span style=color:#eceff4>;
</span><span>    </span><span style=color:#616e88>// handler.join().unwrap();
</span><span>    </span><span style=color:#81a1c1>for</span><span> i </span><span style=color:#81a1c1>in </span><span style=color:#b48ead>1</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>10 </span><span>{
</span><span>        println!(</span><span style=color:#a3be8c>"hi number </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>, from main thread!"</span><span style=color:#eceff4>,</span><span> i)</span><span style=color:#eceff4>;
</span><span>        thread</span><span style=color:#81a1c1>::</span><span>sleep(Duration</span><span style=color:#81a1c1>::</span><span>from_secs(</span><span style=color:#b48ead>1</span><span>))</span><span style=color:#eceff4>;
</span><span>    }
</span><span>    handler</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span>()</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><h2 id=moveyi-dong-suo-you-quan-dao-bi-bao>move移动所有权到闭包</h2><p>如下所是<code>move</code>会移动<code>vec</code>的所有权到闭包中去<pre class=language-rust data-lang=rust style=background:#2e3440;color:#d8dee9><code class=language-rust data-lang=rust><span style=color:#81a1c1>use </span><span>std</span><span style=color:#81a1c1>::</span><span>{thread</span><span style=color:#eceff4>, </span><span>time</span><span style=color:#81a1c1>::</span><span>Duration</span><span style=color:#eceff4>,</span><span> vec}</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>fn </span><span style=color:#88c0d0>main</span><span>() {
</span><span>    </span><span style=color:#81a1c1>let</span><span> v </span><span style=color:#81a1c1>= </span><span>vec![</span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>2</span><span style=color:#eceff4>, </span><span style=color:#b48ead>3</span><span style=color:#eceff4>, </span><span style=color:#b48ead>4</span><span style=color:#eceff4>, </span><span style=color:#b48ead>5</span><span>]</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>let</span><span> handler </span><span style=color:#81a1c1>= </span><span>thread</span><span style=color:#81a1c1>::</span><span>spawn(</span><span style=color:#81a1c1>move || </span><span>{
</span><span>        </span><span style=color:#81a1c1>for</span><span> i </span><span style=color:#81a1c1>in</span><span> v</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span>() {
</span><span>            println!(</span><span style=color:#a3be8c>"hi number </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>, from the spawn thread!"</span><span style=color:#eceff4>,</span><span> i)</span><span style=color:#eceff4>;
</span><span>            thread</span><span style=color:#81a1c1>::</span><span>sleep(Duration</span><span style=color:#81a1c1>::</span><span>from_secs(</span><span style=color:#b48ead>1</span><span>))</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    })</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>for</span><span> i </span><span style=color:#81a1c1>in </span><span style=color:#b48ead>1</span><span style=color:#81a1c1>..=</span><span style=color:#b48ead>5 </span><span>{
</span><span>        println!(</span><span style=color:#a3be8c>"hi number </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>, from main thread!"</span><span style=color:#eceff4>,</span><span> i)</span><span style=color:#eceff4>;
</span><span>        thread</span><span style=color:#81a1c1>::</span><span>sleep(Duration</span><span style=color:#81a1c1>::</span><span>from_secs(</span><span style=color:#b48ead>1</span><span>))</span><span style=color:#eceff4>;
</span><span>    }
</span><span>
</span><span>    handler</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span>()</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><h2 id=tokiode-yi-bu-duo-xian-cheng>tokio的异步多线程</h2><pre class=language-rust data-lang=rust style=background:#2e3440;color:#d8dee9><code class=language-rust data-lang=rust><span style=color:#81a1c1>use </span><span>tokio</span><span style=color:#81a1c1>::</span><span>{sync</span><span style=color:#81a1c1>::</span><span>mpsc</span><span style=color:#eceff4>, </span><span>time</span><span style=color:#81a1c1>::</span><span>Instant}</span><span style=color:#eceff4>;
</span><span>
</span><span>#[tokio::main]
</span><span>async </span><span style=color:#81a1c1>fn </span><span style=color:#88c0d0>main</span><span>() {
</span><span>    </span><span style=color:#81a1c1>let</span><span> now </span><span style=color:#81a1c1>= </span><span>Instant</span><span style=color:#81a1c1>::</span><span>now()</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>let </span><span>(tx</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>mut</span><span> rx) </span><span style=color:#81a1c1>= </span><span>mpsc</span><span style=color:#81a1c1>::</span><span>channel(</span><span style=color:#b48ead>1000000</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>for</span><span> i </span><span style=color:#81a1c1>in </span><span style=color:#b48ead>1</span><span style=color:#81a1c1>..=</span><span style=color:#b48ead>1000000 </span><span>{
</span><span>        </span><span style=color:#81a1c1>let</span><span> tx1 </span><span style=color:#81a1c1>=</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span>()</span><span style=color:#eceff4>;
</span><span>        tokio</span><span style=color:#81a1c1>::</span><span>spawn(async </span><span style=color:#81a1c1>move </span><span>{
</span><span>            tx1</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span>(format!(</span><span style=color:#a3be8c>"</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>-</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hi"</span><span style=color:#eceff4>,</span><span> i))</span><span style=color:#81a1c1>.</span><span>await</span><span style=color:#eceff4>;
</span><span>        })</span><span style=color:#eceff4>;
</span><span>    }
</span><span>
</span><span>    tokio</span><span style=color:#81a1c1>::</span><span>spawn(async </span><span style=color:#81a1c1>move </span><span>{
</span><span>        tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span>(</span><span style=color:#8fbcbb>String</span><span style=color:#81a1c1>::</span><span>from(</span><span style=color:#a3be8c>"final string!"</span><span>))</span><span style=color:#81a1c1>.</span><span>await</span><span style=color:#eceff4>;
</span><span>    })</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>while let </span><span style=color:#8fbcbb>Some</span><span>(v) </span><span style=color:#81a1c1>=</span><span> rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span>()</span><span style=color:#81a1c1>.</span><span>await {
</span><span>        println!(</span><span style=color:#a3be8c>"</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>"</span><span style=color:#eceff4>,</span><span> v)</span><span style=color:#eceff4>;
</span><span>    }
</span><span>
</span><span>    println!(</span><span style=color:#a3be8c>"use </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> seconds"</span><span style=color:#eceff4>,</span><span> now</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>elapsed</span><span>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs</span><span>())</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre></main><footer><p class=tagsData><a href=/tags/rust>#Rust</a><hr><div class=footContainer><div class=footLeft>Built with <a rel="noopener noreferrer" href=https://github.com/getzola/zola target=_blank>Zola</a></div><div class=footRight><img class="footGif noStyle" alt=footGif loading=lazy src=https://i.ibb.co/XYDpfcs/foot.gif><a href="https://nova-me.github.io/ atom.xml" rel="noopener noreferrer" title="Subscribe via RSS for updates." class=metaData target=_blank>RSS</a></div></div></footer></div>