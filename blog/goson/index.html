<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Goson使用总结</title><meta content=Goson使用总结 name=title><meta content=NOVA-ME name=author><meta content="The road is life." name=description><meta content=website property=og:type><meta content=https://nova-me.github.io/blog/goson/ property=og:url><meta content=NOVA-ME property=og:site_name><meta content=Goson使用总结 property=og:title><meta content="The road is life." property=og:description><meta content=https://nova-me.github.io/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nova-me.github.io/blog/goson/ property=twitter:url><meta content=Goson使用总结 property=twitter:title><meta content="The road is life." property=twitter:description><meta content=https://nova-me.github.io/favicon.ico property=twitter:image><link href=https://nova-me.github.io/blog/goson/ rel=canonical><link rel="shortcut icon" href=https://nova-me.github.io/favicon.ico type=image/x-icon><link href="https://nova-me.github.io/ atom.xml" rel=alternate title=RSS type=application/atom+xml><link href=https://nova-me.github.io/css/style.css rel=stylesheet><body><div class=wrapper><header><nav class=navBar><a href=/>/home/</a><a href=/about>/about/</a><a href=/blog>/blog/</a><a href=/tags>/tags/</a><div class=themeSwitch><button class="themeButton light" onclick="setTheme('light')" title="Light mode">◐</button><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode">◑</button></div><script>const setTheme=a=>{document.documentElement.className=a;localStorage.setItem('theme',a)};const getTheme=()=>{const a=localStorage.getItem('theme');a&&setTheme(a)};getTheme()</script></nav><div><a href=..>..</a>/<span class=metaData>goson</span></div><time datetime=2019-10-03>Published on: <span class=metaData>2019-10-03</span></time><h1>Goson使用总结</h1></header><main><p>这篇文章是对Gson的内部实现原理进行一个总结</p><span id=continue-reading></span><h2 id=chuang-jian-fang-fa>创建方法</h2><p>Gson可以由两种方式创建，一种是通过Gson.Builder()的方式，另一种则是通过new Gson()来创建。<p>那这两种创建方式有什么不同呢？<p>第一种Gson.Builder()的方法没有使用反射，而new Gson()是使用了反射的。<p>在Gson内部存在着TypeAdapter，也就是根据不同的类型来适配，当我们使用Gson.Builder()创建时，使用的是自定义的TypeAdapter而不是默认的TypeAdapter，因此也就出现了一个为反射，一个不是反射<pre class=language-java data-lang=java style=background:#2e3440;color:#d8dee9><code class=language-java data-lang=java><span style=color:#88c0d0>Gson</span><span>(</span><span style=color:#8fbcbb>Excluder</span><span> excluder</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>FieldNamingStrategy</span><span> fieldNamingPolicy</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Map</span><span><</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>InstanceCreator</span><span><</span><span style=color:#81a1c1>?</span><span>>> instanceCreators</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>boolean</span><span> serializeNulls</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>boolean</span><span> complexMapKeySerialization</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>boolean</span><span> generateNonExecutableGson</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>boolean</span><span> htmlSafe</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>boolean</span><span> prettyPrinting</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>boolean</span><span> serializeSpecialFloatingPointValues</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>LongSerializationPolicy</span><span> longSerializationPolicy</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>List</span><span><</span><span style=color:#8fbcbb>TypeAdapterFactory</span><span>> typeAdapterFactories) {
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>calls </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>ThreadLocal</span><span>()</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>typeTokenCache </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>Collections</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>synchronizedMap</span><span>(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>HashMap</span><span>())</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>deserializationContext </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>JsonDeserializationContext</span><span>() {
</span><span>            </span><span style=color:#81a1c1>public </span><span><</span><span style=color:#8fbcbb>T</span><span>> </span><span style=color:#8fbcbb>T </span><span style=color:#88c0d0>deserialize</span><span>(</span><span style=color:#8fbcbb>JsonElement </span><span>json</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Type </span><span>typeOfT) throws </span><span style=color:#8fbcbb>JsonParseException </span><span>{
</span><span>                </span><span style=color:#81a1c1>return </span><span style=color:#8fbcbb>Gson</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>fromJson</span><span>(json</span><span style=color:#eceff4>,</span><span> typeOfT)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>        }</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>serializationContext </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>JsonSerializationContext</span><span>() {
</span><span>            </span><span style=color:#81a1c1>public </span><span style=color:#8fbcbb>JsonElement </span><span style=color:#88c0d0>serialize</span><span>(</span><span style=color:#8fbcbb>Object </span><span>src) {
</span><span>                </span><span style=color:#81a1c1>return </span><span style=color:#8fbcbb>Gson</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toJsonTree</span><span>(src)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#81a1c1>public </span><span style=color:#8fbcbb>JsonElement </span><span style=color:#88c0d0>serialize</span><span>(</span><span style=color:#8fbcbb>Object </span><span>src</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Type </span><span>typeOfSrc) {
</span><span>                </span><span style=color:#81a1c1>return </span><span style=color:#8fbcbb>Gson</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toJsonTree</span><span>(src</span><span style=color:#eceff4>,</span><span> typeOfSrc)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>        }</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>constructorConstructor </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>ConstructorConstructor</span><span>(instanceCreators)</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>serializeNulls </span><span style=color:#81a1c1>=</span><span> serializeNulls</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>generateNonExecutableJson </span><span style=color:#81a1c1>=</span><span> generateNonExecutableGson</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>htmlSafe </span><span style=color:#81a1c1>=</span><span> htmlSafe</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>prettyPrinting </span><span style=color:#81a1c1>=</span><span> prettyPrinting</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#8fbcbb>ArrayList</span><span> factories </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>ArrayList</span><span>()</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>JSON_ELEMENT_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>ObjectTypeAdapter</span><span style=color:#eceff4>.</span><span>FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(excluder)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addAll</span><span>(typeAdapterFactories)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>STRING_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>INTEGER_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>BOOLEAN_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>BYTE_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>SHORT_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>newFactory</span><span>(</span><span style=color:#8fbcbb>Long</span><span style=color:#eceff4>.</span><span>TYPE</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Long</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>class</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>longAdapter</span><span>(longSerializationPolicy)))</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>newFactory</span><span>(</span><span style=color:#8fbcbb>Double</span><span style=color:#eceff4>.</span><span>TYPE</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Double</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>class</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>doubleAdapter</span><span>(serializeSpecialFloatingPointValues)))</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>newFactory</span><span>(</span><span style=color:#8fbcbb>Float</span><span style=color:#eceff4>.</span><span>TYPE</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Float</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>class</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>floatAdapter</span><span>(serializeSpecialFloatingPointValues)))</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>NUMBER_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>CHARACTER_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>STRING_BUILDER_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>STRING_BUFFER_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>newFactory</span><span>(</span><span style=color:#8fbcbb>BigDecimal</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>class</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>BIG_DECIMAL))</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>newFactory</span><span>(</span><span style=color:#8fbcbb>BigInteger</span><span style=color:#eceff4>.</span><span style=color:#81a1c1>class</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>BIG_INTEGER))</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>URL_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>URI_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>UUID_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>LOCALE_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>INET_ADDRESS_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>BIT_SET_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>DateTypeAdapter</span><span style=color:#eceff4>.</span><span>FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>CALENDAR_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TimeTypeAdapter</span><span style=color:#eceff4>.</span><span>FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>SqlDateTypeAdapter</span><span style=color:#eceff4>.</span><span>FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>TIMESTAMP_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>ArrayTypeAdapter</span><span style=color:#eceff4>.</span><span>FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>ENUM_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>CLASS_FACTORY)</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>CollectionTypeAdapterFactory</span><span>(</span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>constructorConstructor))</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>MapTypeAdapterFactory</span><span>(</span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>constructorConstructor</span><span style=color:#eceff4>,</span><span> complexMapKeySerialization))</span><span style=color:#eceff4>;
</span><span>        factories</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>ReflectiveTypeAdapterFactory</span><span>(</span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>constructorConstructor</span><span style=color:#eceff4>,</span><span> fieldNamingPolicy</span><span style=color:#eceff4>,</span><span> excluder))</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span>factories </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>Collections</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>unmodifiableList</span><span>(factories)</span><span style=color:#eceff4>;
</span><span>    }
</span></code></pre><p>那Gson如何判断我们使用的是哪一种方法创建呢？其实就是通过factories这个对象 add Factory的顺序来控制的。每次获取Adapter的时候都需要遍历Factories，而我们自定义的TypeAdapter在add时是会默认添加到靠前的位置。所以这样就避免了Gson的反射解析<h2 id=ru-he-shi-xian-jie-xi>如何实现解析</h2><p>Gson中存在一个JsonParser类，它的作用就是将json串解析成JsonElement对象。<pre class=language-java data-lang=java style=background:#2e3440;color:#d8dee9><code class=language-java data-lang=java><span style=color:#81a1c1>public </span><span style=color:#8fbcbb>JsonElement </span><span style=color:#88c0d0>parse</span><span>(</span><span style=color:#8fbcbb>String</span><span> json) throws </span><span style=color:#8fbcbb>JsonSyntaxException </span><span>{
</span><span>        </span><span style=color:#81a1c1>return this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>parse</span><span>((</span><span style=color:#8fbcbb>Reader</span><span>)(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>StringReader</span><span>(json)))</span><span style=color:#eceff4>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#81a1c1>public </span><span style=color:#8fbcbb>JsonElement </span><span style=color:#88c0d0>parse</span><span>(</span><span style=color:#8fbcbb>Reader</span><span> json) throws </span><span style=color:#8fbcbb>JsonIOException</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>JsonSyntaxException </span><span>{
</span><span>        </span><span style=color:#81a1c1>try </span><span>{
</span><span>            </span><span style=color:#8fbcbb>JsonReader</span><span> e </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>JsonReader</span><span>(json)</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#8fbcbb>JsonElement</span><span> element </span><span style=color:#81a1c1>= this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>parse</span><span>(e)</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#81a1c1>if</span><span>(</span><span style=color:#81a1c1>!</span><span>element</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>isJsonNull</span><span>() </span><span style=color:#81a1c1>&&</span><span> e</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>peek</span><span>() </span><span style=color:#81a1c1>!= </span><span style=color:#8fbcbb>JsonToken</span><span style=color:#eceff4>.</span><span>END_DOCUMENT) {
</span><span>                </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonSyntaxException</span><span>(</span><span style=color:#a3be8c>"Did not consume the entire document."</span><span>)</span><span style=color:#eceff4>;
</span><span>            } </span><span style=color:#81a1c1>else </span><span>{
</span><span>                </span><span style=color:#81a1c1>return</span><span> element</span><span style=color:#eceff4>;
</span><span>            }
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>MalformedJsonException </span><span>var4) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonSyntaxException</span><span>(var4)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>IOException </span><span>var5) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonIOException</span><span>(var5)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>NumberFormatException </span><span>var6) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonSyntaxException</span><span>(var6)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#81a1c1>public </span><span style=color:#8fbcbb>JsonElement </span><span style=color:#88c0d0>parse</span><span>(</span><span style=color:#8fbcbb>JsonReader</span><span> json) throws </span><span style=color:#8fbcbb>JsonIOException</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>JsonSyntaxException </span><span>{
</span><span>        </span><span style=color:#81a1c1>boolean</span><span> lenient </span><span style=color:#81a1c1>=</span><span> json</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>isLenient</span><span>()</span><span style=color:#eceff4>;
</span><span>        json</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setLenient</span><span>(</span><span style=color:#81a1c1>true</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>        </span><span style=color:#8fbcbb>JsonElement</span><span> e</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>try </span><span>{
</span><span>            e </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>Streams</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>parse</span><span>(json)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>StackOverflowError </span><span>var8) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonParseException</span><span>(</span><span style=color:#a3be8c>"Failed parsing JSON source: " </span><span style=color:#81a1c1>+</span><span> json </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>" to Json"</span><span style=color:#eceff4>,</span><span> var8)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>OutOfMemoryError </span><span>var9) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonParseException</span><span>(</span><span style=color:#a3be8c>"Failed parsing JSON source: " </span><span style=color:#81a1c1>+</span><span> json </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>" to Json"</span><span style=color:#eceff4>,</span><span> var9)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>finally </span><span>{
</span><span>            json</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setLenient</span><span>(lenient)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#81a1c1>return</span><span> e</span><span style=color:#eceff4>;
</span><span>    }
</span></code></pre><p>注意上面的第三个方法，里面实际上返回的是Stream.parse(json)<pre class=language-java data-lang=java style=background:#2e3440;color:#d8dee9><code class=language-java data-lang=java><span style=color:#81a1c1>public static </span><span style=color:#8fbcbb>JsonElement </span><span style=color:#88c0d0>parse</span><span>(</span><span style=color:#8fbcbb>JsonReader</span><span> reader) throws </span><span style=color:#8fbcbb>JsonParseException </span><span>{
</span><span>        </span><span style=color:#81a1c1>boolean</span><span> isEmpty </span><span style=color:#81a1c1>= true</span><span style=color:#eceff4>;
</span><span>
</span><span>        </span><span style=color:#81a1c1>try </span><span>{
</span><span>            reader</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>peek</span><span>()</span><span style=color:#eceff4>;
</span><span>            isEmpty </span><span style=color:#81a1c1>= false</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#81a1c1>return </span><span>(</span><span style=color:#8fbcbb>JsonElement</span><span>)</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span>JSON_ELEMENT</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>read</span><span>(reader)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>EOFException </span><span>var3) {
</span><span>            </span><span style=color:#81a1c1>if</span><span>(isEmpty) {
</span><span>                </span><span style=color:#81a1c1>return </span><span style=color:#8fbcbb>JsonNull</span><span style=color:#eceff4>.</span><span>INSTANCE</span><span style=color:#eceff4>;
</span><span>            } </span><span style=color:#81a1c1>else </span><span>{
</span><span>                </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonSyntaxException</span><span>(var3)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>MalformedJsonException </span><span>var4) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonSyntaxException</span><span>(var4)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>IOException </span><span>var5) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonIOException</span><span>(var5)</span><span style=color:#eceff4>;
</span><span>        } </span><span style=color:#81a1c1>catch </span><span>(</span><span style=color:#8fbcbb>NumberFormatException </span><span>var6) {
</span><span>            </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>JsonSyntaxException</span><span>(var6)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }
</span></code></pre><p>这里又返回了TypeAdapters.JSON_ELEMENT.read(reader)方法，那我们就来看看read方法又返回了什么。<pre class=language-java data-lang=java style=background:#2e3440;color:#d8dee9><code class=language-java data-lang=java><span style=color:#81a1c1>public </span><span style=color:#8fbcbb>JsonElement </span><span style=color:#88c0d0>read</span><span>(</span><span style=color:#8fbcbb>JsonReader</span><span> in) throws </span><span style=color:#8fbcbb>IOException </span><span>{
</span><span>                </span><span style=color:#81a1c1>switch</span><span>(</span><span style=color:#8fbcbb>TypeAdapters</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>SyntheticClass_1</span><span style=color:#eceff4>.</span><span>$</span><span style=color:#8fbcbb>SwitchMap$com$google$gson$stream$JsonToken</span><span>[in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>peek</span><span>()</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>ordinal</span><span>()]) {
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>1</span><span style=color:#81a1c1>:
</span><span>                    </span><span style=color:#8fbcbb>String</span><span> number </span><span style=color:#81a1c1>=</span><span> in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>nextString</span><span>()</span><span style=color:#eceff4>;
</span><span>                    </span><span style=color:#81a1c1>return new </span><span style=color:#8fbcbb>JsonPrimitive</span><span>(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>LazilyParsedNumber</span><span>(number))</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>2</span><span style=color:#81a1c1>:
</span><span>                    </span><span style=color:#81a1c1>return new </span><span style=color:#8fbcbb>JsonPrimitive</span><span>(</span><span style=color:#8fbcbb>Boolean</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>valueOf</span><span>(in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>nextBoolean</span><span>()))</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>3</span><span style=color:#81a1c1>:
</span><span>                    </span><span style=color:#81a1c1>return new </span><span style=color:#8fbcbb>JsonPrimitive</span><span>(in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>nextString</span><span>())</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>4</span><span style=color:#81a1c1>:
</span><span>                    in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>nextNull</span><span>()</span><span style=color:#eceff4>;
</span><span>                    </span><span style=color:#81a1c1>return </span><span style=color:#8fbcbb>JsonNull</span><span style=color:#eceff4>.</span><span>INSTANCE</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>5</span><span style=color:#81a1c1>:
</span><span>                    </span><span style=color:#8fbcbb>JsonArray</span><span> array </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>JsonArray</span><span>()</span><span style=color:#eceff4>;
</span><span>                    in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>beginArray</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>                    </span><span style=color:#81a1c1>while</span><span>(in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>hasNext</span><span>()) {
</span><span>                        array</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>read</span><span>(in))</span><span style=color:#eceff4>;
</span><span>                    }
</span><span>
</span><span>                    in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>endArray</span><span>()</span><span style=color:#eceff4>;
</span><span>                    </span><span style=color:#81a1c1>return</span><span> array</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>6</span><span style=color:#81a1c1>:
</span><span>                    </span><span style=color:#8fbcbb>JsonObject</span><span> object </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>JsonObject</span><span>()</span><span style=color:#eceff4>;
</span><span>                    in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>beginObject</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>                    </span><span style=color:#81a1c1>while</span><span>(in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>hasNext</span><span>()) {
</span><span>                        object</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span>(in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>nextName</span><span>()</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>read</span><span>(in))</span><span style=color:#eceff4>;
</span><span>                    }
</span><span>
</span><span>                    in</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>endObject</span><span>()</span><span style=color:#eceff4>;
</span><span>                    </span><span style=color:#81a1c1>return</span><span> object</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>7</span><span style=color:#81a1c1>:
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>8</span><span style=color:#81a1c1>:
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>9</span><span style=color:#81a1c1>:
</span><span>                </span><span style=color:#81a1c1>case </span><span style=color:#b48ead>10</span><span style=color:#81a1c1>:
</span><span>                </span><span style=color:#81a1c1>default:
</span><span>                    </span><span style=color:#81a1c1>throw new </span><span style=color:#8fbcbb>IllegalArgumentException</span><span>()</span><span style=color:#eceff4>;
</span><span>                }
</span><span>            }
</span></code></pre><p>从这上面的case我们不难看出，这里实际上就是根据不同的数据类型进行不同的数据解析。例如case 6,针对的是一个object类型，也就获取它的name和value放入object中，case 5则是针对的Array类型。<p>所以实际上就是解析Json，然后返回一个调用者想要的对象<h2 id=yi-ju-hua-zong-jie>一句话总结</h2><p>两种创建方式，区别在于一个是反射一个不是反射。如果想要避免使用反射，自定义TypeAdapter即可，factories会自动将其添加到list的前面，当使用时就会优先遍历到指定的adapter。 JsonParser对Json串进行解析处理，根据对应的数据类型最终返回给用户一个指定的对象。这也就是我们创建一个对象实体类的原因</main><footer><p class=tagsData><a href=/tags/java>#Java</a><hr><div class=footContainer><div class=footLeft>Built with <a rel="noopener noreferrer" href=https://github.com/getzola/zola target=_blank>Zola</a></div><div class=footRight><img class="footGif noStyle" alt=footGif loading=lazy src=https://i.ibb.co/XYDpfcs/foot.gif><a href="https://nova-me.github.io/ atom.xml" rel="noopener noreferrer" title="Subscribe via RSS for updates." class=metaData target=_blank>RSS</a></div></div></footer></div>